<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.24.1" />

  <title> &middot; Hov&#39;s Blog</title>

  <script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "https://hm.baidu.com/hm.js?dd096f3aba9332e2640cda59d3786695";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>	
  
  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.2/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.2/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.2/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://HauyuChen.github.io/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://HauyuChen.github.io/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="https://HauyuChen.github.io/css/blackburn.css">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type="text/css">

  
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/styles/androidstudio.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="https://HauyuChen.github.io/img/favicon.ico" type="image/x-icon" />

  
  

	

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  <a class="pure-menu-heading brand" href="https://HauyuChen.github.io/">
  <img src="https://HauyuChen.github.io/img/Hov.jpg" width="125px">
</a>

  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://HauyuChen.github.io/"><i class='fa fa-home fa-fw'></i>主页</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://HauyuChen.github.io/post/"><i class='fa fa-list fa-fw'></i>所有文章</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://HauyuChen.github.io/tags/"><i class='fa fa-tags fa-fw'></i>文章分类</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://HauyuChen.github.io/topics/"><i class='fa fa-folder fa-fw'></i>关键词</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://HauyuChen.github.io/about/"><i class='fa fa-user fa-fw'></i>关于我</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://HauyuChen.github.io/contact/"><i class='fa fa-home fa-fw'></i>关于本站</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/HauyuChen" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>


</div>

</div>


  <div id="main">


<div class="header">
  <h1></h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>0001-01-01</time>
  </div>

  

  

  

</div>

  

<h1 id="0-前言">0 前言</h1>

<p>智能停车系统是本人在大二下学期做的一个小项目。项目难度不大，主要涉及传感器数据采集、ZigBee组网、GPRS传输数据、数据库服务器程序的编写、微信公众账号开发，我们还做了一个小模型用来展示。</p>

<h3 id="zb-p-01">ZB-P-01</h3>

<p>在本文中将着重讲述ZigBee部分，如何通过ZigBee网络采集数据并将数据发送给远程数据库服务器。</p>

<p>本文侧重讲的是实现思路，具体的技术细节可参考源代码。</p>

<p><br/></p>

<h1 id="1-项目简介">1 项目简介</h1>

<p>智能停车系统通过无线传感器网络监测停车场内的车位状态和亮度信息等数据，并对数据进行处理和存储，实现停车引导、防盗提醒和灯光控制等功能。</p>

<p>系统通过ZigBee结合GPRS无线网络将数据发送并存储到数据库服务器，最终通过客户端、移动终端等方式实现交互。用户还可以关注本停车系统的微信公众账号实时地了解停车场内的信息。本系统旨在提升停车场管理效率，改善用户体验。</p>

<p><br/></p>

<h1 id="2-项目思路">2 项目思路</h1>

<p>ZigBee部分主要完成的是传感器数据的采集和数据的传输,大体的思路是这样的：通过ZigBee终端节点上外接的传感器实现数据监测，并通过ZigBee网络将数据发送至ZigBee协调器，ZigBee协调器通过RS232串口线连接GPRS模块，通过AT指令将数据发送至远程数据库服务器。</p>

<h2 id="2-1-zigbee协调器">2.1 ZigBee协调器</h2>

<p>ZigBee协调器主要完成以下功能：</p>

<ul>
<li>组建ZigBee网络，供ZigBee终端等节点连接；</li>
<li>接收ZigBee终端发送的数据，经过处理后通过RS232串口发送给与之相连接的GPRS模块。如将停车场内的车位数据和亮度数据发送给远程数据库服务器。</li>
<li>根据空闲车位的数量，控制车位指示屏</li>

<li><h2 id="2-2-zigbee终端">2.2 ZigBee终端</h2>

<p>ZigBee终端节点主要负责以下功能：</p></li>

<li><p>采集车位数据（红外传感器）、采集亮度数据（光照数字传感器）、控制车位状态灯（LED灯）；</p></li>

<li><p>将采集到的数据通过ZigBee网络发送给ZigBee协调器。</p></li>

<li><p>接收ZigBee协调器发送过来的数据，并进行相应的处理，如开关灯操作。</p></li>
</ul>

<h2 id="2-3-gprs模块">2.3 GPRS模块</h2>

<p>要把 ZigBee 网络采集到的数据发送给远程数据库服务器，可选用 GPRS 模块。通过SIM卡，利用 GPRS 网络将数据发送出去。GPRS模块主要完成以下功能：</p>

<ul>
<li>建立TCP连接，连接到远程服务器。</li>
<li>发送数据给远程服务器，接收远程服务器返回的数据；</li>
<li>发送防盗提醒短信给用户。</li>
</ul>

<p><br/></p>

<h1 id="3-实现细节">3 实现细节</h1>

<h2 id="3-1-zigbee终端">3.1 ZigBee终端</h2>

<p>前面已经提到ZigBee终端节点负责的功能，下面说说ZigBee终端如何实现这些功能。</p>

<h3 id="3-1-1-数据采集">3.1.1 数据采集</h3>

<p>ZigBee终端通过外接传感器采集数据，比如在本项目中用到的传感器主要是红外传感器、光照数字传感器。
（1）红外传感器
红外传感器采用黑白对管红外避障模块，有三个引脚，VCC。GND、OUT。探测距离可调，当前方有障碍物时OUT口输出1，否则输出0。使用较为方便，但是稳定性不足，也可考虑用超声波探测模块来替换。
如何探测车位状态。其实很简单，将传感器的OUT口连接到ZigBee终端的一个IO口，通过判断这个IO口的值来模拟车位是否被占用，控制车位状态灯（IO口）。当车位被占用，OUT口输出1；车位空闲，OUT口输出0。
实现代码参考附录的源代码（ParkingStatus.c）</p>

<p>（2）光照数字传感器
光照数字传感器用来采集停车场内的亮度数据，该传感器可以采集到周围环境的亮度值。该传感器采用IIC总线方式，有四个引脚（VCC、GND、SCL、SDA），将其与ZigBee终端连接即可，采集到的数据将通过ZigBee网络发送至ZigBee协调器。
实现代码参考附录的源代码（LightControl.c）</p>

<h3 id="3-1-2-发送数据">3.1.2 发送数据</h3>

<p>在ZigBee网络中如何发送数据呢？看过协议栈例程的都应该清楚。ZigBee协议栈中发送数据的函数是 AF_DataRequest 。在此函数中我们主要考虑三个参数：簇ID（标识符）、数据大小、数据存放位置（数组名）。</p>

<p>下面是ZigBee终端发送车位数据给ZigBee协调器的代码：</p>

<pre><code>void SampleApp_SendPointToPointMessage_Car( void )
{
  uint8 PD[4];
  /* 车位区域 */
  PD[0]=0+65;   //A区车位
  /* 该区域车位状态(只模拟其中三个车位) */
  PD[1]=S001+48;
  PD[2]=S002+48;
  PD[3]=S003+48;
  
  if ( AF_DataRequest( &amp;Point_To_Point_DstAddr,
                       &amp;SampleApp_epDesc,
                       SAMPLEAPP_SEND_DATA_CAR_CLUSTERID,
                       4,
                       PD,  //车位数据
                       &amp;SampleApp_TransID,
                       AF_DISCV_ROUTE,
                       AF_DEFAULT_RADIUS ) == afStatus_SUCCESS )
  {
  }
  else
  {
    // Error occurred in request to send.
  }
}

</code></pre>

<p>也就是说，要把车位数据发送给协调器，调用这样的一个函数就行了。当然这个函数可参考例程自己写，只需修改部分代码即可。</p>

<h3 id="3-1-3-灯光控制">3.1.3 灯光控制</h3>

<p>ZigBee终端还负责更新车位状态灯和停车场内照明灯的功能。车位状态灯和停车场照明灯的实现方式大体一致，所以下面就拿车位状态灯来讲好了：</p>

<p>车位状态灯用LED灯泡来模拟，将LED灯连接到ZigBee终端的相应IO口，然后控制这些IO口的状态就可以模拟车位状态了。比如前面提到车位状态通过红外传感器采集，有车输出1，没车输出0。所以我们只需判断该车位的红外传感器采集到的是0还是1，根据这个数值来控制特定的IO口即可。</p>

<p>举个栗子，模拟A001车位状态：在A001车位上方安放红外传感器、红色LED灯、绿色LED灯。将红外传感器连接P0_2引脚、红色LED灯连接P1_2引脚、绿色LED灯连接P1_4引脚。所以当A001车位有车时，红外传感器采集到数据，OUT口输出1，此时P0_2口的值为1。所以我们只需判断P0_2口的值就可以知道车位的状态了。比如为1时车位被占用，亮红色LED灯（P1_2置1，P1_4置0）；为0时车位空闲，亮绿色LED灯（P1_2置0，P1_4置1）。</p>

<h2 id="3-2-zigbee协调器">3.2 ZigBee协调器</h2>

<h3 id="3-2-1-接收数据">3.2.1 接收数据</h3>

<p>ZigBee协调器是ZigBee网络的数据中心，ZigBee网络内所有的ZigBee终端节点采集到的数据都会发送给协调器。ZigBee协调器负责接收车位状态信息和停车场内亮度等数据。</p>

<p>在ZigBee协议栈Z-Stack中，接收数据的流程是这样的：</p>

<h3 id="zb-p-02">ZB-P-02</h3>

<h3 id="3-2-2-车位指示屏">3.2.2 车位指示屏</h3>

<p>车位指示屏的作用是显示剩余的空闲车位数量。在本停车系统中，每个路口设置一个车位指示屏，用来指示当前区域剩余的空闲车位数量。本模型中用数码管来模拟。</p>

<p>ZigBee协调器将车位数据发送给远程数据库服务器，服务器会计算出剩余的空闲车位数量，ZigBee协调器根据返回的数值来更新数码管。</p>

<h2 id="3-3-gprs模块">3.3 GPRS模块</h2>

<p>GPRS这个名词想必大家都听说过。在还没3G、4G之前，GPRS还是我们比较常用的手机上网手段。现在我们想知道的是怎么通过GPRS模块将数据发送出去，就像我们手机插上SIM卡为什么就能上网了？GPRS模块当然也需要一张SIM卡，一张支持GSM网络的手机SIM卡。</p>

<p>GPRS模块怎么用？其实，GPRS模块是用AT指令来操作的，比如我们要建立TCP连接，我们要发送短信，这些都是通过AT指令来操作的。</p>

<p>在本系统中采用华为 GTM900-C 无线模块，这是一款两频段GSM/GPRS 无线模块。它支持标准的AT 命令及增强AT 命令，提供丰富的语音和数据业务等功能，是高速数据传输等各种应用的理想解决方案。</p>

<h3 id="3-3-1-建立tcp连接">3.3.1 建立TCP连接</h3>

<h3 id="zb-p-03">ZB-P-03</h3>

<h3 id="zb-p-04">ZB-P-04</h3>

<h3 id="3-3-2-发送短信">3.3.2 发送短信</h3>

<p>发送短信的AT指令分三步：
第一步：AT+CMGF=0   //模式选择
第二步：AT+CMGS=49  //设置短信长度，49是我们设置的长度
第三步：“0011000D9168”+目标手机号码+短信内容      //发送内容</p>

<p>（1）首先，我们要知道目标手机号码，还要经过小小的转换。
举个栗子，向手机号码15767977442发送短信，那么手机号部分就应该是5167977744F2。
找到规律了吗？在最后一个数字后加上F，然后奇数位和偶数位对换。01234567890就应该变成1032547698F0对不对。</p>

<p>（2）短信的内容是什么？发送中文短信应该将中文转换成unicode。
举个例子，我们要发送“您的车已离开车位，如有异常请致电X”，那么AT指令中的短信内容就应该是这样的：0008A72260A876848F665DF279BB5F008F664F4DFF0C598267095F025E388BF781F475350058 。嗯，这一串数字就是上面那句中文的unicode，可以用汉字转UNICODE工具转换。</p>

<p>综上，我们要想手机号码15767977442发送短信“您的车已离开车位，如有异常请致电X”。AT指令应该是这样的：
<1>AT+CMGF=0
<2>AT+CMGS=49
<3>0011000D91685167977744F20008A72260A876848F665DF279BB5F008F664F4DFF0C598267095F025E388BF781F475350058
注意：每句AT指令应该以ctrl+z结束，也就是\r\n。</p>

<h1 id="4-防盗模式与管理员模式">4 防盗模式与管理员模式</h1>

<h2 id="4-1-防盗模式">4.1 防盗模式</h2>

<p>用户停车后，点选所停车位，开启防盗提醒。当车子离开车位，系统自动发送一条提醒短信给客户的手机。
假设将车子停在A003车位，停好车后点击A003，开启防盗模式；当车子离开车位，系统自动向该微信号绑定的手机号码发送提醒短信。</p>

<h3 id="zb-p-05">ZB-P-05</h3>

<h2 id="4-2-管理员模式">4.2 管理员模式</h2>

<p>在PC客户端和微信公众平台均可进入管理员模式。在管理员模式下可以查看停车场内实时的车位信息和亮度等数据。</p>

<h3 id="4-2-1-pc客户端">4.2.1 PC客户端</h3>

<p>（1）停车场灯光</p>

<ul>
<li>自动模式：选择自动模式，停车场照明灯自动根据环境亮度控制，当亮度低于10LX时自动开灯，否则不开灯；</li>
<li>手动模式：选择手动模式，停车场管理员可以对照明灯进行手动控制</li>
<li>信息显示：动态显示照明灯状态；动态显示亮度值；</li>
</ul>

<p>（2）车位情况</p>

<ul>
<li>动态显示停车场内的空闲车位的总数以及各分区的空闲车位数量；</li>
<li>动态更新停车场车位状态图，空闲车位亮绿色，已被使用车位亮红色。</li>
</ul>

<h3 id="zb-p-06">ZB-P-06</h3>

<h3 id="4-2-2-微信公众帐号">4.2.2 微信公众帐号</h3>

<p>在本停车系统的微信公众平台上，输入7获取管理员模式入口，输入用户名：admin，密码xxx，验证成功后跳出管理员模式连接，可查询停车场车位、亮度信息，对停车场内照明灯进行控制。</p>

<h3 id="zb-p-07">ZB-P-07</h3>

<h1 id="5-其它">5 其它</h1>

<h2 id="5-1-服务器程序">5.1 服务器程序</h2>

<p>服务器程序接收ZigBee采集到的数据，并将数据存储在数据库，方便与客户端、移动终端交互。服务器程序用JAVA编写，主要涉及到Socket编程、多线程等知识。</p>

<h3 id="zb-p-08">ZB-P-08</h3>

<h2 id="5-2-数据库">5.2 数据库</h2>

<p>数据库采用SQL Server2012搭建。数据库结构不复杂，就几张表，很简单。</p>

<h3 id="zb-p-09">ZB-P-09</h3>

<h2 id="5-3-pc客户端">5.3 PC客户端</h2>

<p>PC客户端采用C#编写，主要涉及Socket编程、控件的使用。停车场管理员可以在PC客户端上实时地查看停车场内的相关数据。</p>

<h3 id="zb-p-10">ZB-P-10</h3>

<h2 id="5-4-微信公众帐号">5.4 微信公众帐号</h2>

<p>微信公众平台为用户提供与停车场交互的途径。用户可在微信公众平台上实时地获取本停车场的相关信息，如车位数量、车辆状态等。</p>

<h3 id="zb-p-11">ZB-P-11</h3>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
  </div>
  <div class="pure-u-10-24">
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="https://HauyuChen.github.io/post/008-string-to-integeratoi/">【LeetCode】8. String to Integer (atoi)</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="https://HauyuChen.github.io/post/008-string-to-integeratoi/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>



  
<div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = "http-hov-space";
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


</div>

</div>
</div>
<script src="https://HauyuChen.github.io/js/ui.js"></script>






</body>
</html>

